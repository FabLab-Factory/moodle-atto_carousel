YUI.add("moodle-atto_carousel-button",function(m,e){var r={ADDIMAGE:"atto_carousel_addmore",ELEMENT:"carousel-element",RESPONSIVE:"img-responsive",INPUTALIGNMENT:"atto_carousel_alignment",INPUTALT:"atto_carousel_altentry",INPUTHEIGHT:"atto_carousel_heightentry",INPUTSUBMIT:"atto_carousel_urlentrysubmit",INPUTADDIMAGE:"atto_carousel_addimage",INPUTURL:"atto_carousel_urlentry",INPUTSIZE:"atto_carousel_size",INPUTWIDTH:"atto_carousel_widthentry",IMAGEALTWARNING:"atto_carousel_altwarning",IMAGEBROWSER:"atto_carousel_openimagebrowser",IMAGEPRESENTATION:"atto_carousel_presentation",INPUTCONSTRAIN:"atto_carousel_constrain",INPUTCUSTOMSTYLE:"atto_carousel_customstyle",IMAGEPREVIEW:"atto_carousel_preview",IMAGEPREVIEWBOX:"atto_carousel_preview_box",ALIGNSETTINGS:"atto_carousel_button"},t={INPUTURL:"."+r.INPUTURL},o=[{name:"verticalAlign",str:"alignment_top",value:"text-top",margin:"0 0.5em"}],p="atto_carousel";IMAGETEMPLATE='<div class="carousel-item"><img class="{{slidenumber}}" src="{{url}}" alt="Carousel slide"><div class="container"><div class="carousel-caption d-none d-md-block text-left"></div></div></div>',CAROUSELTEMPLATE='<div class="no-columns"><div id="{{carouselid}}" class="carousel column-carousel slide" data-ride="carousel"><div class="carousel-inner" role="listbox"></div><a class="carousel-control-prev invert" href="#{{carouselid}}" role="button" data-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="sr-only">Previous</span></a><a class="carousel-control-next invert" href="#{{carouselid}}" role="button" data-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="sr-only">Next</span></a></div></div>',m.namespace("M.atto_carousel").Button=m.Base.create("button",m.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_attoform:null,_numberOfImages:1,_rawImageDimensions:null,initializer:function(){this.addButton({icon:M.util.image_url("ed/editor_icon1","atto_carousel"),callback:this._displayDialogue,tags:".carousel",tagMatchRequiresAll:!1}),this.editor.delegate("dblclick",this._displayDialogue,".carousel",this),this.editor.delegate("click",this._handleClick,".carousel",this),this.editor.on("drop",this._handleDragDrop,this),this.editor.on("dragover",function(e){e.preventDefault()},this),this.editor.on("dragenter",function(e){e.preventDefault()},this)},_handleDragDrop:function(e){var t,i,s,n,o,a,l,r,c,u=this,d=this.get("host"),g=m.Handlebars.compile(IMAGETEMPLATE);if(d.saveSelection(),(e=e._event).dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length&&/^image\//.test(e.dataTransfer.files[0].type)){for(i=(t=d.get("filepickeroptions").image).savepath===undefined?"/":t.savepath,s=new FormData,n=0,o="",a=new XMLHttpRequest,l="",r=Object.keys(t.repositories),e.preventDefault(),e.stopPropagation(),s.append("repo_upload_file",e.dataTransfer.files[0]),s.append("itemid",t.itemid),c=0;c<r.length;c++)if("upload"===t.repositories[r[c]].type){s.append("repo_id",t.repositories[r[c]].id);break}return s.append("env",t.env),s.append("sesskey",M.cfg.sesskey),s.append("client_id",t.client_id),s.append("savepath",i),s.append("ctx_id",t.context.id),n=(new Date).getTime(),o="moodleimage_"+Math.round(1e5*Math.random())+"-"+n,d.focus(),d.restoreSelection(),l=g({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",p),id:o}),d.insertContentAtFocusPoint(l),u.markUpdated(),a.onreadystatechange=function(){var e,t,i,s,n=u.editor.one("#"+o);if(4===a.readyState)if(200===a.status){if(e=JSON.parse(a.responseText)){if(e.error)return n&&n.remove(!0),new M.core.ajaxException(e);(t=e).event&&"fileexists"===e.event&&(t=e.newfile),i=g({url:t.url,presentation:!0}),s=m.Node.create(i),n?n.replace(s):u.editor.appendChild(s),u.markUpdated()}}else m.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),n&&n.remove(!0)},a.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),a.send(s),!1}},_handleClick:function(e){var t=e.target,i=this.get("host").getSelectionFromNode(t);this.get("host").getSelection()!==i&&this.get("host").setSelection(i)},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection&&(this._rawImageDimensions=null,this.getDialogue({headerContent:M.util.get_string("imageproperties",p),width:"auto",focusAfterHide:!0,focusOnShowSelector:t.INPUTURL}).set("bodyContent",this._getDialogueContent()).show())},_loadPreviewImage:function(e){var t=new Image,i=this;t.onerror=function(){i._attoform.one("."+r.IMAGEPREVIEW+"-"+indexImage).setStyles({display:"none"}),i.getDialogue().centerDialogue()},t.onload=function(){var e;i._rawImageDimensions={width:this.width,height:this.height},(e=i._attoform.one("."+r.IMAGEPREVIEW+"-"+indexImage)).setAttribute("src",this.src),e.setStyles({display:"inline"}),i.getDialogue().centerDialogue()},t.src=e},_getDialogueContent:function(){var e,t=m.Handlebars.compile(
'<form class="atto_attoform"><div class="container"><div class="row"><div class="col-md-6">{{#if showFilepicker}}<div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><div class="input-group input-append w-100"><input class="form-control {{CSS.INPUTURL}} {{CSS.INPUTURL}}-1" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><span class="input-group-append"><button class="btn btn-secondary {{CSS.IMAGEBROWSER}} {{CSS.IMAGEBROWSER}}-1" type="button">{{get_string "browserepositories" component}}</button></span></div></div>{{else}}<div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="form-control fullwidth {{CSS.INPUTURL}} {{CSS.INPUTURL}}-1" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/></div>{{/if}}<div class="form-inline mb-1"><label class="for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="custom-select {{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}">{{get_string str ../component}}</option>{{/each}}</select></div><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/></div><div class="col-md-6"><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}} {{CSS.IMAGEPREVIEW}}-1" alt="" style="display: none;"/></div></div></div></div><div class="row {{CSS.ADDIMAGE}}"><div class="col-12"><button class="btn btn-secondary {{CSS.INPUTADDIMAGE}}" type="button">{{get_string "addimage" component}}</button></div></div><div class="row"><button class="btn btn-secondary {{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></div></form>'),i=this.get("host").canShowFilepicker("image"),s=m.Node.create(t({elementid:this.get("host").get("elementid"),CSS:r,component:p,showFilepicker:i,alignments:o}));return this._attoform=s,this._applyImageProperties(this._attoform,1),this._attoform.one("."+r.INPUTURL+"-1").on("blur",this._getUrlChanged(this._attoform,1),this),this._attoform.one("."+r.INPUTSUBMIT).on("click",this._setCarousel,this),i&&s.delegate("click",function(e){var t=this._attoform;e.preventDefault(),this.get("host").showFilepicker("image",this._getFilepickerCallback(t,1),this)},".atto_carousel_openimagebrowser-1",this),e=this.get("host").get("elementid"),this._attoform.one("."+r.INPUTADDIMAGE).on("click",this._getAddNewImage(this._attoform,this._numberOfImages,e,r,p,i,o,this),this),s},_filepickerCallback:function(e){""!==e.url&&(this._attoform.one("."+r.INPUTURL+"-1").set("value",e.url),this._loadPreviewImage(e.url))},_getFilepickerCallback:function(i,s){return function(e){var t;""!==e.url&&(i.one("."+r.INPUTURL+"-"+s).set("value",e.url),(t=new Image).onerror=function(){i.one("."+r.IMAGEPREVIEW+"-"+s).setStyles({display:"none"})},t.onload=function(){var e;(e=i.one("."+r.IMAGEPREVIEW+"-"+s)).setAttribute("src",this.src),e.setStyles({display:"inline"})},t.src=e.url)}},_getAddNewImage:function(n,o,a,l,r,c,u,d){return function(){var t,e,i,s;console.log("context",d),e='<div class="row"><div class="col-md-6">{{#if showFilepicker}}<div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><div class="input-group input-append w-100"><input class="form-control {{CSS.INPUTURL}} {{CSS.INPUTURL}}-'+(t=o+1)+'" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><span class="input-group-append"><button class="btn btn-secondary {{CSS.IMAGEBROWSER}} {{CSS.IMAGEBROWSER}}-'+t+'" type="button">{{get_string "browserepositories" component}}</button></span></div></div>{{else}}<div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="form-control fullwidth {{CSS.INPUTURL}} {{CSS.INPUTURL}}-'+t+'" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/></div>{{/if}}<div class="form-inline mb-1"><label class="for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="custom-select {{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}">{{get_string str ../component}}</option>{{/each}}</select></div><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/></div><div class="col-md-6"><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}} {{CSS.IMAGEPREVIEW}}-'+t+'" alt="" style="display: none;"/></div></div></div></div>',i=m.Handlebars.compile(e),s=m.Node.create(i({elementid:a,CSS:l,component:r,showFilepicker:c,alignments:u})),n.insert(s,m.one("."+l.ADDIMAGE)),this._applyImageProperties(n,t),n.one("."+l.INPUTURL+"-"+t).on("blur",this._getUrlChanged(n,t),this),c&&n.delegate("click",function(e){e.preventDefault(),this.get("host").showFilepicker("image",this._getFilepickerCallback(n,t),this)},".atto_carousel_openimagebrowser-"+t,this)}},_getUrlChanged:function(i,s){return function(){var e,t=this._attoform.one("."+r.INPUTURL+"-"+s);""!==t.get("value")&&((e=new Image).onerror=function(){i.one("."+r.IMAGEPREVIEW+"-"+s).setStyles({display:"none"})},e.onload=function(){var e;(e=i.one("."+r.IMAGEPREVIEW+"-"+s)).setAttribute("src",this.src),e.setStyles({display:"inline"})},e.src=params.url)}},_applyImageProperties:function(e,t){var i=this._getSelectedImageProperties(),s=e.one("."+r.IMAGEPREVIEW+"-"+t);if(!1===i)return s.setStyle("display","none"),void o.some(function(e){return!!e.isDefault},this);i.align&&e.one("."+r.INPUTALIGNMENT).set("value",i.align),i.customstyle&&e.one("."+r.INPUTCUSTOMSTYLE).set("value",i.customstyle),i.src&&(e.one("."+r.INPUTURL+"-"+t).set("value",i.src),this._loadPreviewImage(i.src,t))},_getSelectedImageProperties:function(){var e,t,i={src:null,alt:null,align:"",presentation:!1},s=this.get("host").getSelectedNodes();return(s=s&&s.filter("img"))&&s.size()?(t=this._removeLegacyAlignment(s.item(0)),e=(this._selectedImage=t).getAttribute(
"style"),i.customstyle=e,this._getAlignmentPropeties(t,i),i.src=t.getAttribute("src"),i.presentation="presentation"===t.get("role"),i):(this._selectedImage=null,!1)},_getAlignmentPropeties:function(i,s){var n;!o.some(function(e){var t=this._getAlignmentClass(e.value);return i.hasClass(t)?(s.align=e.value,!0):(e.isDefault&&(n=e.value),!1)},this)&&n&&(s.align=n)},_urlChanged:function(){var e=this._attoform.one("."+r.INPUTURL+"-1");""!==e.get("value")&&this._loadPreviewImage(e.get("value"),1)},_setImage:function(e){var t,i=this._attoform,s=i.one("."+r.INPUTURL).get("value"),n=this._getAlignmentClass(i.one("."+r.INPUTALIGNMENT).get("value")),o=i.one("."+r.INPUTCUSTOMSTYLE).get("value"),a=[],l=this.get("host");e.preventDefault(),this._updateWarning()||(l.focus(),""!==s&&(this._selectedImage?l.setSelection(l.getSelectionFromNode(this._selectedImage)):l.setSelection(this._currentSelection),a.push(n),t=m.Handlebars.compile(IMAGETEMPLATE)({url:s,customstyle:o,classlist:a.join(" ")}),this.get("host").insertContentAtFocusPoint(t),this.markUpdated()),this.getDialogue({focusAfterHide:null}).hide())},_setCarousel:function(e){var t,i=this.get("host");e.preventDefault(),this._updateWarning()||(t=m.Handlebars.compile(CAROUSELTEMPLATE),carousel=t({carouselid:"carousel-1-en"}),i.focus(),this.get("host").insertContentAtFocusPoint(carousel),this.markUpdated(),this.getDialogue({focusAfterHide:null}).hide())},_removeLegacyAlignment:function(i){return i.getStyle("margin")&&o.some(function(e){if(i.getStyle(e.name)!==e.value)return!1;var t=m.Node.create("<div>");return t.setStyle("margin",e.margin),i.getStyle("margin")===t.getStyle("margin")&&(i.addClass(this._getAlignmentClass(e.value)),i.setStyle(e.name,null),i.setStyle("margin",null),!0)},this),i},_getAlignmentClass:function(e){return r.ALIGNSETTINGS+"_"+e},_updateWarning:function(){return!1}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});